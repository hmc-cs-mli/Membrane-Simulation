#!/bin/bash

# variables 

size=100
lipidtype=$1
chol=$2
time=20
asym=$3

# energy minimization

fp=${lipidtype}_${size}_${asym}_CHOL_${chol}
mkdir $fp
cd $fp
mkdir em
cd em
../../files/insane.py -l ${lipidtype}:${size} -l CHOL:${chol} -u ${lipidtype}:${size} -u CHOL:${chol} -pbc square -sol W -x 7.5 -y 7.5 -z 10 -o ${fp}.gro -p top.top -asym $asym
cat ../../files/header.txt top.top > topol.top
sed -i ‘’ 12d topol.top
gmx grompp -f ../../files/minimization${lipidtype}.mdp -c ${fp}.gro -p topol.top -o em.tpr > /dev/null
gmx mdrun -deffnm em -v > /dev/null
cd ..

# 1fs

mkdir 1fs
cp em/em.gro em/topol.top 1fs
cd 1fs
gmx grompp -f ../../files/martini_v2.x_new-rf.1fs.${lipidtype}.mdp -c em.gro -p topol.top -o 1fs.tpr > /dev/null
gmx mdrun -deffnm 1fs -v -nt 4 > /dev/null
cd ..

# 5fs 

mkdir 5fs
cp 1fs/1fs.gro 1fs/topol.top 5fs
cd 5fs
gmx grompp -f ../../files/martini_v2.x_new-rf.5fs.${lipidtype}.mdp -c 1fs.gro -p topol.top -o 5fs.tpr > /dev/null
gmx mdrun -deffnm 5fs -v -nt 4 > /dev/null
cd ..

# 15fs

mkdir 15fs
cp 5fs/5fs.gro 5fs/topol.top 15fs
cd 15fs
gmx grompp -f ../../files/martini_v2.x_new-rf.15fs.${lipidtype}.mdp -c 5fs.gro -p topol.top -o 15fs.tpr > /dev/null
gmx mdrun -deffnm 15fs -v -nt 4 > /dev/null
cd ..

# 30fs

mkdir 20fs
cp 15fs/15fs.gro 15fs/topol.top 20fs
cd 20fs
gmx grompp -f ../../files/martini_v2.x_new-rf.prod_run.${lipidtype}.mdp -c 20fs.gro -p topol.top -o 20fs.tpr > /dev/null
gmx mdrun -deffnm 20fs -v -nt 4 > /dev/null

# indexing

mkdir analysis
cd analysis
gmx make_ndx -f ../20fs.gro -o index.ndx
echo a PO4 ROH
echo name 5 headgroups
echo del 0-4
echo q
fatslim membranes -c ../20fs.gro -n index.ndx --output-index bilayer_leaflet.ndx

# analysis

../../../files/area-lipid-g5.py ../20fs.edr 0 170 100 310 > ener-area-out.xvg
fatslim thickness -c ../20fs.gro -n index.ndx -t ../20fs.xtc --plot-thickness thickness.xvg
fatslim apl -c ../20fs.gro -n index.ndx -t ../20fs.xtc --plot-apl apl.xvg --plot-area area.xvg
echo 2 2 | gmx trjconv -f ../20fs.xtc -s ../20fs.tpr -o traj-center-mol.xtc -center -n index.ndx -pbc mol
gmx msd -f traj-center-mol.xtc -n index.ndx -lateral z -b 0 -e 170 -s ../20fs.tpr -rncomm -o diffusion.xvg

# clean up

cp -r ../analysis ../../../
rm -r ../../../$fp
